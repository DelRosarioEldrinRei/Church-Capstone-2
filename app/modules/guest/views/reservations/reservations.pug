extends ../../../../templates/guests
block main
	style.
		#header-style-1 {
			background-image: url(/imgchurch/reservation.jpg)
		}
		.btn-sm {
			font-size: 12px;
			min-width: 40px;
			padding: 5px 11px;
		}
		.form-control
			{
				display:block;
				width:100%;
				min-height:20px;
				padding:.375rem .75rem;
				font-size:.75rem;
				line-height:1.5;
				color:#495057;
				background-color:#fff;
				background-clip:padding-box;
				border:1px solid #ced4da;
				border-radius:.25rem;
				transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out
			}
			.custom-select.custom-select-sm.form-control.form-control-sm {
				margin:0;
			}
	#headers
		#header-style-1
			.container
				.header-caption
					.row
						.col-md-12.header-content
							h3.header-title.animated.fadeInDown.invisible
								span.text-primary Helium - 
								| Bootstrap 4 UI Kit
							h5.header-text.animated.fadeIn.invisible
								| Lorem ipsum dolor sit amet, consectetuer adipiscing elit<br>Lorem ipsum dolor sit amet, consectetuer.</h5>
							//- a.page-scroll.btn.btn-lg.btn-default-filled.animated.fadeInUp.invisible(href="#") Download Now
							//- a.page-scroll.btn.btn-lg.btn-common.animated.fadeInUp.invisible(href="#") Explore
		#raised-section.main.main-raised
			section.form-box
				.container
					.row
						.col-md-12.form-wizard
							h3 Reservation List
							p 
					.row
						.col-lg-12.col-md-12.mb-60
							table.table#dataTable
								thead
									tr.text-center
										th Name
										th Status
										th Event Date
										th Event Time
										th Actions
								tbody
									each reservation in reservations
										tr.text-center
											td.eventname(value=reservation.var_eventname)=reservation.var_eventname
											td=reservation.char_approvalstatus
											td=reservation.date_eventdate
											td=reservation.time_eventstart
											td.td-actions
												button.btn-info.btn-sm.viewButton(type='button',rel='tooltip', value=reservation.int_eventinfoID) View
												button.btn-success.btn-sm.updateButton(type='button',rel='tooltip', value=reservation.int_eventinfoID) Edit
												button.btn.btn-danger.btn-sm.cancelButton(type='button',rel='tooltip',value=`${reservation.int_eventinfoID}`) Cancel
												| &nbsp;
	#viewModal.modal.fade(tabindex="-2" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true")
			.modal-dialog.modal-lg(role="document")
				.modal-content
					.modal-header(style='background:#367587; color:white')
						h4.modal-title(style='background:#367587; color:white') View Application Form
						button.close(type='button', data-dismiss='modal', aria-label='Close')
							span(aria-hidden='true' style='background:#367587; color:white') ×
					.modal-body#viewBodyAppend
					.modal-footer
						button.btn.btn-outline.btn-secondary.pull-left#cancelButton(type='button', data-dismiss='modal') Close
	#updateModal.modal.fade(tabindex="-2" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true")
		.modal-dialog.modal-lg(role="document")
			.modal-content
				.modal-header(style='background:#367587; color:white')
					h4.modal-title(style='background:#367587; color:white') Update Application
				.modal-body#updateBodyAppend
				.modal-footer
					button.btn.btn-outline.btn-secondary.pull-left#cancelButton(type='button', data-dismiss='modal') Close
					button.btn.btn-outline.btn-secondary.pull-left#confirmButton(type='button', data-dismiss='modal') Update
	#messageModal.modal.fade(tabindex="-2" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true")
		.modal-dialog.modal-lg(role="document")
			.modal-content
				.modal-header(style='background:red')
					h5.modal-title(style='color:white') Message for the Guest
					button.close(type='button', data-dismiss='modal', aria-label='Close')
						span(aria-hidden='true' style='color:white') ×
				.modal-body#messageAppend
				.modal-footer
					//- button.btn.btn-outline.btn-secondary.pull-left#cancellButton(type='button', data-dismiss='modal') Close
					button.btn.btn-danger#sendMessage(type="button") Send

block addjs
	script.
		$(document).ready(function() {

			$('#dataTable').DataTable( {
				responsive: {
						details: {
							display: $.fn.dataTable.Responsive.display.modal( {
									header: function ( row ) {
											var data = row.data();
											return 'Details for '+data[0]+' '+data[1];
									}
							} ),
							renderer: $.fn.dataTable.Responsive.renderer.tableAll( {
									tableClass: 'table'
							} )
						}
				}
				});
				$(document).on('click','.viewButton',function(){
				var idNow = $(this).val()
				console.log(idNow)
				console.log($('.eventname').attr('value'))
				var eventname = $('.eventname').attr('value')
				$.post('/guest/reservation/query',{id:idNow,eventname:eventname}).done(data=>{
					if(data[0].var_eventname == "Baptism" || data[0].var_eventname == "Special Baptism"){
					var dateRequested = moment(data[0].date_eventdate).format('MM/DD/YYYY')
					var timeRequested = moment(data[0].time_eventstart).format('hh:mm A')
					var age = moment().diff(data.date_birthday,'years');
					$('#viewBodyAppend').append(`
					<table class="tableModal">
						<tr>
							<td class="tdModal h5"><strong> Desired Date: </strong> ${dateRequested}</td>
							<td class="tdModal h5"><strong> Desired Time:  </strong> ${timeRequested}</td>
						</tr>
						<tr>
							<td class="tdModal h5"><strong> Name of the Relative: </strong> ${data[0].var_lname}, ${data[0].var_fname}</td>
							<td class="tdModal h5"><strong> Gender:  </strong> ${data[0].char_gender}</td>
						</tr>
						<tr>
							<td class="tdModal h5"><strong> Relationship:  </strong> ${data[0].var_relation}</td>
							<td class="tdModal h5"><strong> Contact No.:  </strong> ${data[0].var_contactnum}</td>
						</tr>
						<tr>
							<td class="tdModal h5"><strong> Birth Date:  </strong> ${moment(data[0].date_birthday).format('YYYY-MM-DD')}</td>
							<td class="tdModal h5"><strong> Birth Place:  </strong> ${data[0].var_birthplace}</td>
						</tr>
						<tr>
							<td class="tdModal h5"><strong> Mother's Name:  </strong> ${data[0].var_mothername}</td>
							<td class="tdModal h5"><strong> Mother's Birthplace:  </strong> ${data[0].var_motherbplace}</td>
						</tr>
						<tr>
							<td class="tdModal h5"><strong> Father's Name:  </strong> ${data[0].var_fathername}</td>
							<td class="tdModal h5"><strong> Father's Birthplace:  </strong> ${data[0].var_fatherbplace}</td>
						</tr>
						<tr>
							<td class="tdModal h5"><strong> Address:  </strong> ${data[0].var_address}</td>
							<td class="tdModal h5"><strong> Parent Marriage Address:  </strong> ${data[0].var_parentmarriageadd}</td>
						</tr>
						<div id="refund" class="form-group">
						</div>
					`)
					if(data[0].char_approvalstatus){
						$('#refund').append(`
						<button type="button id="refundslip" class="btn btn-primary">Refund Slip</button>
						`)
						$(document).on(	'click', '#refundslip', function(){ // yung #voucherButton yung id nung button
							$(document).off('click', '#refundslip')
							
						})
					}
					}
					else if(data[0].var_eventname == "Anointing of the sick" || data[0].var_eventname == "Funeral Service"){
						var dateRequested = moment(data[0].date_eventdate).format('MM/DD/YYYY')
						var timeRequested = moment(data[0].time_eventstart,'HH:mm:ss').format('hh:mm A')
						$('#viewBodyAppend').append(`
						<table class="tableModal">
						<tr>
							<td class="tdModal h5"><strong> Desired Date: </strong> ${dateRequested}</td>
							<td class="tdModal h5"><strong> Desired Time:  </strong> ${timeRequested}</td>
						</tr>
						<tr>
							<td class="tdModal h5"><strong> Name of the Relative: </strong> ${data[0].var_lname}, ${data[0].var_fname}</td>
							<td class="tdModal h5"><strong> Gender:  </strong> ${data[0].char_gender}</td>
						</tr>
						<tr>
							<td class="tdModal h5"><strong> Relationship:  </strong> ${data[0].var_relation}</td>
						</tr>
						<tr>
							<td class="tdModal h5"><strong> Birth Date:  </strong> ${moment(data[0].date_birthday).format('YYYY-MM-DD')}</td>
							<td class="tdModal h5"><strong> Birth Place:  </strong> ${data[0].var_birthplace}</td>
						</tr>
						<tr>
							<td class="tdModal h5"><strong> Address:  </strong> ${data[0].var_address}</td>
						</tr>
						<div id="refund" class="form-group">
						</div>
						`)
					}
					$('#viewModal').modal('show')
					$('#viewModal').on('hidden.bs.modal',function(){
						$('#viewBodyAppend').empty()
					})
				})
				})
				$(document).on('click','.updateButton',function(){
					var idNow = $(this).val()
					console.log(idNow)
					var eventname = $('.eventname').attr('value')
					$.post('/guest/reservation/query',{id:idNow,eventname:eventname}).done(data=>{
						if(data[0].char_approvalstatus == "Pending"){
						if(data[0].var_eventname == "Baptism" || data[0].var_eventname == "Special Baptism"){
							var birthday = moment(data[0].date_birthday).format('YYYY-MM-DD')
							console.log(birthday)
							$('#updateBodyAppend').append(
								`
								<div class="form-group">
									<label class="label-control">Name of the Relative</label>
									<label class="label-control">First Name</label>
									<input type="text" id="firstname" value="${data[0].var_fname}" class="form-control">
									<label class="label-control">Middle Name</label>
									<input type="text" id="middlename" value="${data[0].var_mname}" class="form-control">
									<label class="label-control">Last Name</label>
									<input type="text" id="lastname" value="${data[0].var_lname}" class="form-control">
								</div>
								<div class="form-group">
									<h6 class="label-control">Gender
									<div class="text-danger d-inline"> *</div>
									<div class="custom-control custom-radio">
										<input class="custom-control-input" id="customRadio1" type="radio" name="gender" value="Male" />
										<label class="custom-control-label" for="customRadio1">
										Male</label>
									</div>
									<div class="custom-control custom-radio">
										<input class="custom-control-input" id="customRadio2" type="radio" name="gender" value="Female" />
										<label class="custom-control-label" for="customRadio2">
										Female</label>
									</div>
									</h6>
								</div>
								<div class="row">
									<div class="col-md-6">
										<div class="form-group">
											<select id="relation" type="text" name="relation" required="">
											</select>
										</div>
									</div>
									<div class="col-md-6">
										<div class="form-group mt-1">
										<label class="label-control">Contact No.</label>
										<input type="text" id="contactnum" value="${data[0].var_contactnum}" class="form-control">
										</div>
									</div>
								</div>
								<div class="form-group">
									<label class="label-control">Birth Date</label>
									<input type="date" id="birthdate" class="date-picker1 form-control" value='${birthday}'>
								</div>
								<div class="form-group">
									<label class="label-control">Date Birth Place
										<input type="text" id="birthplace" value="${data[0].var_birthplace}" class="form-control">
									</label>
								</div>
								<div class="form-group">
									<label class="label-control">Mother's Name
										<input type="text" id="mothername" value="${data[0].var_mothername}" class="form-control">
									</label>
									<label class="label-control">Mother's Birth Place
										<input type="text" id="motherbplace" value="${data[0].var_motherbplace}" class="form-control">
									</label>
								</div>
								<div class="form-group">
									<label class="label-control">Father's Name
										<input type="text" id="fathername" value="${data[0].var_fathername}" class="form-control">
									</label>
									<label class="label-control">Father's Birth Place
										<input type="text" id="fatherbplace" value="${data[0].var_fatherbplace}" class="form-control">
									</label>
								</div>
								<div class="form-group">
									<label class="label-control">Address
										<input type="text" id="address" value="${data[0].var_address}" class="form-control">
									</label>
									<label class="label-control">Parent's Marriage Address
										<input type="text" id="parentmarriageaddress" value="${data[0].var_parentmarriageadd}" class="form-control">
									</label>
								</div>
								`)
								$('#updateModal').modal('show');
								$('#updateModal').on('hidden.bs.modal',function(){
									$('#updateBodyAppend').empty()
								})
								if(data[0].char_gender == "Male"){
								$('#customRadio1').prop('checked', true);
								}
								else if(data[0].char_gender == "Female"){
								$('#customRadio2').prop('checked', true);
								}
								if(data[0].var_relation == "Aunt/Uncle"){
									$('#relation').append(`
									<option id="relationAppend" selected="" value="" disabled="disabled">Choose...</option>
									<option selected="">Aunt/Uncle</option>
									<option>Parent</option>
									<option>Grandparent</option>
									<option>Sibling</option>
									`)								
								}
								else if(data[0].var_relation == "Parent"){
									$('#relation').append(`
									<option id="relationAppend" selected="" value="" disabled="disabled">Choose...</option>
									<option>Aunt/Uncle</option>
									<option selected="">Parent</option>
									<option>Grandparent</option>
									<option>Sibling</option>
									`)								
								}
								else if(data[0].var_relation == "Grandparent"){
									$('#relation').append(`
									<option id="relationAppend" selected="" value="" disabled="disabled">Choose...</option>
									<option>Aunt/Uncle</option>
									<option>Parent</option>
									<option selected="">Grandparent</option>
									<option>Sibling</option>
									`)								
								}
								else if(data[0].var_relation == "Sibling"){
									$('#relation').append(`
									<option id="relationAppend" selected="" value="" disabled="disabled">Choose...</option>
									<option>Aunt/Uncle</option>
									<option>Parent</option>
									<option>Grandparent</option>
									<option selected="">Sibling</option>
									`)								
								}
							$('#confirmButton').click(function(){
								console.log(idNow)
								var firstname = $('#firstname').val()
								var middlename = $('#middlename').val()
								var lastname = $('#lastname').val()
								var gender;
								var relation = $('#relation').val()
								var contactnum = $('#contactnum').val()
								var birthplace = $('#birthplace').val()
								var mothername = $('#mothername').val()
								var motherbplace = $('#motherbplace').val()
								var fathername = $('#fathername').val()
								var fatherbplace = $('#fatherbplace').val()
								var address = $('#address').val()
								var parentmarriageaddress = $('#parentmarriageaddress').val()
								if ($("#customRadio1").prop("checked")) {
								gender = $("#customRadio1").val();
								}
								else if($("#customRadio2").prop("checked")){
								gender = $("#customRadio2").val();
								}
								var birthdate = moment($('#birthdate').val()).format('YYYY-MM-DD')
								swal({
								title:'Are You Sure?', 
								text:'You want to update the Status of the Requirements?', 
								type:'warning',
								showCancelButton: true,
								confirmButtonColor: '#3085d6',
								cancelButtonColor: '#d33',
								confirmButtonText: 'Confirm'
								}).then((result)=>{
								if(result.value){
									console.log($('#firstname').val())
									$.post('/guest/reservation/query/update',{
										firstname:firstname,
										middlename:middlename,
										lastname:lastname,
										gender:gender,
										relation:relation,
										contactnum:contactnum,
										birthdate:birthdate,
										birthplace:birthplace,
										mothername:mothername,
										motherbplace:motherbplace,
										fathername:fathername,
										fatherbplace:fatherbplace,
										eventname:data[0].var_eventname,
										address:address,
										parentmarriageaddress:parentmarriageaddress,
										id:idNow,
									}).done(data=>{
										swal({
											title:'Success',
											text:'Status updated and message sent!', 
											type:'success'
										}).then(function(){
											$('#updateModal').modal('hide');
											$('#updateBodyAppend').empty();
											location.reload();
										
										})
									})
								}
								})
							})
						}
						else if(data[0].var_eventname == "Anointing of the sick" || data[0].var_eventname == "Funeral Service"){
							$('#updateBodyAppend').append(`
								<div class="form-group">
									<label class="label-control">Name of the Relative</label>
									<label class="label-control">First Name</label>
									<input type="text" id="firstname" value="${data[0].var_fname}" class="form-control">
									<label class="label-control">Middle Name</label>
									<input type="text" id="middlename" value="${data[0].var_mname}" class="form-control">
									<label class="label-control">Last Name</label>
									<input type="text" id="lastname" value="${data[0].var_lname}" class="form-control">
								</div>
								<div class="form-group">
									<h6 class="label-control">Gender
									<div class="text-danger d-inline"> *</div>
									<div class="custom-control custom-radio">
										<input class="custom-control-input" id="customRadio1" type="radio" name="gender" value="Male" />
										<label class="custom-control-label" for="customRadio1">
										Male</label>
									</div>
									<div class="custom-control custom-radio">
										<input class="custom-control-input" id="customRadio2" type="radio" name="gender" value="Female" />
										<label class="custom-control-label" for="customRadio2">
										Female</label>
									</div>
									</h6>
								</div>
								<div class="row">
									<div class="col-md-6">
										<div class="form-group">
											<select id="relation" type="text" name="relation" required="">
											</select>
										</div>
									</div>
								</div>
								<div class="form-group">
									<label class="label-control">Birth Date</label>
									<input type="date" id="venue" value="${data[0].date_birthday}"class="date-picker1 form-control">
								</div>
								<div class="form-group">
									<label class="label-control">Date Birth Place
										<input type="text" id="birthplace" value="${data[0].var_birthplace}" class="form-control">
									</label>
								</div>
								<div class="form-group">
									<label class="label-control">Address
										<input type="text" id="address" value="${data[0].var_address}" class="form-control">
									</label>
								</div>
								`)
								$('#updateModal').modal('show');
								$('#updateModal').on('hidden.bs.modal',function(){
									$('#updateBodyAppend').empty()
								})
								if(data[0].char_gender == "Male"){
								$('#customRadio1').prop('checked', true);
								}
								else if(data[0].char_gender == "Female"){
								$('#customRadio2').prop('checked', true);
								}
								if(data[0].var_relation == "Aunt/Uncle"){
									$('#relation').append(`
									<option id="relationAppend" selected="" value="" disabled="disabled">Choose...</option>
									<option selected="">Aunt/Uncle</option>
									<option>Parent</option>
									<option>Grandparent</option>
									<option>Sibling</option>
									`)								
								}
								else if(data[0].var_relation == "Parent"){
									$('#relation').append(`
									<option id="relationAppend" selected="" value="" disabled="disabled">Choose...</option>
									<option>Aunt/Uncle</option>
									<option selected="">Parent</option>
									<option>Grandparent</option>
									<option>Sibling</option>
									`)								
								}
								else if(data[0].var_relation == "Grandparent"){
									$('#relation').append(`
									<option id="relationAppend" selected="" value="" disabled="disabled">Choose...</option>
									<option>Aunt/Uncle</option>
									<option>Parent</option>
									<option selected="">Grandparent</option>
									<option>Sibling</option>
									`)								
								}
								else if(data[0].var_relation == "Sibling"){
									$('#relation').append(`
									<option id="relationAppend" selected="" value="" disabled="disabled">Choose...</option>
									<option>Aunt/Uncle</option>
									<option>Parent</option>
									<option>Grandparent</option>
									<option selected="">Sibling</option>
									`)								
								}
							$(document).on('click','#confirmButton',function(){
								var firstname = $('#firstname').val()
								var middlename = $('#middlename').val()
								var lastname = $('#lastname').val()
								var gender;
								var relation = $('#relation').val()
								var contactnum = $('#contactnum').val()
								var birthplace = $('#birthplace').val()
								var mothername = $('#mothername').val()
								var motherbplace = $('#motherbplace').val()
								var fathername = $('#fathername').val()
								var fatherbplace = $('#fatherbplace').val()
								var address = $('#address').val()
								var parentmarriageaddress = $('#parentmarriageaddress').val()
								if ($("#customRadio1").prop("checked")) {
								gender = $("#customRadio1").val();
								}
								else if($("#customRadio2").prop("checked")){
								gender = $("#customRadio2").val();
								}
								var birthdate = moment($('#birthdate').val()).format('YYYY-MM-DD')
								swal({
								title:'Are You Sure?', 
								text:'You want to update the Status of the Requirements?', 
								type:'warning',
								showCancelButton: true,
								confirmButtonColor: '#3085d6',
								cancelButtonColor: '#d33',
								confirmButtonText: 'Confirm'
								}).then((result)=>{
								if(result.value){
									console.log($('#firstname').val())
									$.post('/guest/reservation/query/update',{
										firstname:firstname,
										middlename:middlename,
										lastname:lastname,
										gender:gender,
										relation:relation,
										contactnum:contactnum,
										birthdate:birthdate,
										birthplace:birthplace,
										mothername:mothername,
										motherbplace:motherbplace,
										fathername:fathername,
										fatherbplace:fatherbplace,
										eventname:data[0].var_eventname,
										address:address,
										parentmarriageaddress:parentmarriageaddress,
										id:idNow,
									}).done(data=>{
										swal({
											title:'Success',
											text:'Status updated and message sent!', 
											type:'success'
										}).then(function(){
											$('#updateModal').modal('hide');
											$('#updateBodyAppend').empty();
											location.reload();
										
										})
									})
								}
								})
							})
						}
						}
						else{
							swal({
								title:'Sorry',
								text:'Your application is Approved/Cancelled Already!', 
								type:'warning'
							})
						}
					})
				})
				$(document).on('click','.cancelButton',function(){
					var idNow = $(this).val()
					$.post('/guest/message',{id:idNow}).done(data=>{
					if(data.var_subject != "Cancellation"){
					$('#messageModal').modal('show')
					$('#messageModal').on('hidden.bs.modal',function(){
						$('#selectBox').val('default')
						$('#messageAppend').empty()
					})
					$('#messageAppend').append(`
					<h4 class="c-grey-900 mB-20">Send Message</h4>
						<div class="send-header">
							<div class="form-group">
							<input type="hidden" class='form-control' id='int_receiverID' placeholder="To">
							<input type="text" class='form-control' placeholder="To" value ="Parish Office"  readonly>
							</div>
							<div class="form-group">
							<h6 class="label-control" id="eventstatus">Subject: 
							<label class="label-control"> Cancellation</label>
							<span id="var_subject" class="badge btn btn-primary-lg bgc-blue-100 c-white-700"></span>
							</h6>
							</div>
							<div class="form-group">
							<textarea name="compose" class="form-control" id='text_message' placeholder="Please state your reason why you cancel the event." rows='6'></textarea>
							</div>
						</div>
						<div id="compose-area"></div>
					`)
					$('#sendMessage').click(function(){
						console.log($('#text_message').val())
						var message = $('#text_message').val()
						swal({
						title:'Are you sure?', 
						text:'This message will be sent to the secretariat', 
						type:'warning',
						showCancelButton: false,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonText: 'Confirm'
						}).then((result)=>{
							if(result.value){	
								console.log(message)									
								$.post('/guest/message/send',{
									int_receiverID:6,
									var_subject:"Cancellation",
									text_message:message,
								})
								.done(data=>{
									if(data){
										swal({
											title:'Success',
											text:'Status updated and message sent!', 
											type:'success'
										}).then(function(){
										$('#messageModal').modal('hide');
										$('#messageAppend').empty();
										location.reload();
										})
									}
								})
							}
					})
					})

						}
						else{
							swal({
								title:'Warning',
								text:'Cancellation was sent already!', 
								type:'warning'
							})
						}
					})
				})
		});

