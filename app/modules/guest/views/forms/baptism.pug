extends ../../../../templates/guests
block main
	style.
		@media screen and (max-width: 576px) {
			.col-md-4, .col-md-6, .col-md-9 {
				padding-left: 0;
				padding-right: 0;
			}
			.form-wizard-step {
				padding-bottom: 10px !important;
			}
		}
		#header-style-1 {
			background-image: url(/imgchurch/bible2.png)
		}
		.fc-content {
			font-family: sans-serif !important;
		}
	#headers
		#header-style-1
			.container
				.header-caption
					.row
						.col-md-12.header-content
							h3.header-title.animated.fadeInDown.invisible
								span.text-primary Helium - 
								| Bootstrap 4 UI Kit
							h6.header-text.animated.fadeIn.invisible
								| Lorem ipsum dolor sit amet, consectetuer adipiscing elit<br>Lorem ipsum dolor sit amet, consectetuer.</h6>
							//- a.page-scroll.btn.btn-lg.btn-default-filled.animated.fadeInUp.invisible(href="#") Download Now
							//- a.page-scroll.btn.btn-lg.btn-secondary.animated.fadeInUp.invisible.destination(href="#") Explore
	#raised-section.main.main-raised
		section.form-box
			.container
				.row
					.col-md-12.form-wizard.shadow3
							h3 Baptism Application
							p Fill all form field to go next step
							// Form progress
							.form-wizard-steps.form-wizard-tolal-steps-3
								.form-wizard-progress
									.form-wizard-progress-line(data-now-value='12.25' data-number-of-steps='3' style='width: 12.25%;')
								// Step 1
								.form-wizard-step.active
									.form-wizard-step-icon
										i.fa.fa-location-arrow(aria-hidden='true')
									p.d-none.d-sm-block Baptism Details
								// Step 1
								// Step 2
								.form-wizard-step
									.form-wizard-step-icon
										i.fa.fa-user(aria-hidden='true')
									p.d-none.d-sm-block Personal Information
								// Step 2
								// Step 3
								.form-wizard-step
									.form-wizard-step-icon
										i.fa.fa-briefcase(aria-hidden='true')
									p.d-none.d-sm-block Sponsors Information
								// Step 3
							// Form progress
							// Form Step 1
							fieldset
								h4
									.d-none.d-sm-inline.pull-left Baptism Details: 
									span Step 1 - 3
								.form-group
									br
									h6.label-control.ml-3.mb-0 Baptism Type & Date:
									.container
										.row
											.col-md-3.px-lg-3.px-md-0.px-sm-0
												.form-group
													.custom-control.custom-radio.mt-2
														input#radio1.custom-control-input(type='radio', name='baptismtype' value="Regular")
														label.custom-control-label(for='radio1') 
															h6 Regular
													.custom-control.custom-radio
														input#radio2.custom-control-input(type='radio', name='baptismtype' value="Special")
														label.custom-control-label(for='radio2') 
															h6 Special
											.col-md-9.px-lg-3.px-md-3.px-sm-0
												#regular
													.form-group
														h6.label-control Regular Baptism Date
															.container
																#calendarRegular
												#special
													.form-group
														h6.label-control Special Baptism Date
															.container
																#calendarSpecial
										.learn-more.pull-right
											button#nextButton1.btn(type='button') Next
							// Form Step 1
							// Form Step 2
							fieldset
								h4
									.d-none.d-sm-inline Personal Information: 
									span Step 2 - 3
								.form-group
									br
									input.form-control(type='hidden' name='userID' value=`${user.int_userID}`)
									.container
										h6.label-control Name of the Child:
										.row
											.col-md-4.px-lg-3.px-md-0.px-sm-0
												.form-group.pt-0
													input.form-control#lastname(type='text' placeholder="Last Name" name='lastname' required=''  )
													.help-block.with-errors
											.col-md-4.p-lg-0.px-md-3.px-sm-0
												.form-group.pt-0
													input.form-control#firstname(type='text' placeholder="First Name" name='firstname' required=''  )
													.help-block.with-errors
											.col-md-4.px-lg-3.px-md-0.px-sm-0
												.form-group.pt-0
													input.form-control#middlename(type='text' placeholder="Middle Name" name='middlename'  )
													.help-block.with-errors
										.row
											.col-md-4.px-lg-3.px-md-0.px-sm-0
												.form-group.m-0
													h6.label-control Gender
													.custom-control.custom-radio
														input#customRadio1.custom-control-input(type='radio', name='gender' value="Male")
														label.custom-control-label(for='customRadio1') 
															| Male
													.custom-control.custom-radio
														input#customRadio2.custom-control-input(type='radio', name='gender' value="Female")
														label.custom-control-label(for='customRadio2') 
															| Female

											.col-md-4.p-lg-0.px-md-3.px-sm-0
												.form-group
													h6.label-control Birthday
													input#birthdate.birthday.form-control(type='date' name='birthday' required='')
											.col-md-4.px-lg-3.px-md-0.px-sm-0
												.form-group
													h6.label-control Birthplace:
													input#birthplace.form-control(type='text' name='birthplace' placeholder="Ex. Payatas, Quezon City" required=''  ) 
													.help-block.with-errors
										.row
											.col-md-6.px-lg-3.px-md-3.px-sm-0
												.form-group
													h6.label-control Father's Full Name:
													input#fatherfullname.form-control(type='text' name='fathername' placeholder="Ex. Juan Dela Cruz" required='' )
													.help-block.with-errors
											.col-md-6.px-lg-3.px-md-3.px-sm-0
												.form-group
													h6.label-control Father's Birthplace:
													input#fatherbirthplace.form-control(type='text' name='fatherbirthplace' placeholder="Ex. Caloocan, Quezon City" required='' )
													.help-block.with-errors
										.row
											.col-md-6.px-lg-3.px-md-3.px-sm-0
												.form-group
													h6.label-control Mother's Full name:
													input#motherfullname.form-control(type='text' name='mothername' placeholder="Ex. Maria Dela Cruz" required='' )
													.help-block.with-errors
											.col-md-6.px-lg-3.px-md-3.px-sm-0
												.form-group
													h6.label-control Mother's Birthplace:
													input#motherbirthplace.form-control(type='text' name='motherbirthplace' placeholder="Ex. San Isidro, Quezon City" required=''  )
													.help-block.with-errors
										.row
											.col-md-6.px-lg-3.px-md-3.px-sm-0
												.form-group
													h6.label-control Relationship with the Child
													select#relation(type="text" name='relation' required='')
														option(selected="" value="" disabled) Choose...
														option Aunt/Uncle
														option Parent
														option Grandparent
														option Sibling
											.col-md-6.px-lg-3.px-md-3.px-sm-0
												.form-group
													h6.label-control Family's Contact number
													input#contactnumber.form-control(type='text' name='contactnumber' placeholder="Ex. 09123456789" required='' pattern="[0-9]{11}" )
										.row
											.col-md-6.px-lg-3.px-md-3.px-sm-0
												.form-group
													h6(for='exampleFormControlTextarea1') Parents' Marriage Address:
													textarea#exampleFormControlTextarea1.parentsmarriage.form-control(rows='2' name='marriageaddress' placeholder="Ex. Urban, Bgy. Payatas B 1119 QC" required='' )
											.col-md-6.px-lg-3.px-md-3.px-sm-0
												.form-group
													h6(for='exampleFormControlTextarea1') Family address:
													textarea#exampleFormControlTextarea1.address.form-control(rows='2' name='address' placeholder="Ex. 75 P. Domingo Street, Carmona, Makati City" required='' )
										.row
											.col-md-7.px-lg-3.px-md-3.px-sm-0.mx-auto
												.form-group
													h6.label-control Birth Certificate
													input#file-0b.file(type='file',accept='image/*',name="image")
										.learn-more.pull-right
											button.btn.std-btn.btn-secondary.btn-previous.m-0(type='button') Prev
											button#nextButton2.btn(type='button') Next

							// Form Step 2
							// Form Step 3
							fieldset
								h4
									.d-none.d-sm-inline Sponsors Information:
									span Step 3 - 3
									h6.label-control Principal Sponsors
										.row#principalSponsor
											.col-md-6.px-lg-3.px-md-3.px-sm-0
												.form-group.m-0
													input.sponsorname.form-control(type='text' name='sponsorname' placeholder="Enter Full Name" required=''  )
													.help-block.with-errors
											.col-md-6.px-lg-3.px-md-3.px-sm-0
												.form-group.m-0
													input.sponsorname.form-control.balance(type='text' name='sponsorname' placeholder="Enter Full Name" required=''  )
										button#addAdditionalSponsor.btn.btn-sm-round.btn-common.btn-fab.btn-fab-mini.btn-round.ml-2.rounded-circle(type="button")
											i.fa.fa-plus
									h6.label-control Additional Sponsors
										.row#additionalSponsor
								br
								.learn-more.pull-right
									button.btn.std-btn.btn-secondary.btn-previous.m-0(type='button') Prev
									button.btn.btn-submit#submitButton(type='button') Submit
	#viewModal.modal.fade(tabindex="-2" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true")
			.modal-dialog.modal-lg(role="document")
				.modal-content
					.modal-header
						h5.modal-title Application Request Completed
						button.close(type='button', data-dismiss='modal', aria-label='Close')
							span.p-3(aria-hidden='true') Ã—
					.modal-body
						.col-md-12.px-lg-3.px-md-3.px-sm-0
							.form-group.m-0
								p Your application request has been submitted
						.col-md-6.px-lg-3.px-md-3.px-sm-0
							.form-group.m-0
								label.label-control Voucher
									p Please Print the Voucher and pay until before the due date
									button.btn.std-btn#voucherButton Click to view and downlad
					.modal-footer
						button.btn.std-btn.btn-common.m-0#cancelButton(type='button', data-dismiss='modal' disabled='true') Close
						// Form Wizard
block addjs
	script.
		$('#textarea1').hide();
		$('#textarea2').hide();
		$('#radioup').click(function() {
			$('#textarea1').slideUp();
			$('#textarea2').slideUp();
		});
		$('#exampleRadios1').click(function() {
			$('#textarea1').slideDown();
			$('#textarea2').slideUp();
		});
		$('#exampleRadios3').click(function() {
			$('#textarea1').slideUp();
			$('#textarea2').slideDown();
		});
		$('#regular').hide();
		$('#special').hide();
		var gender;
		$('#nextButton2').click(function(){
			console.log($('#file-0b').val())
			if ($("#customRadio1").prop("checked")) {
			gender = $("#customRadio1").val();
			}
			else if($("#customRadio2").prop("checked")){
			gender = $("#customRadio2").val();
			}
			console.log(gender)
			if(
			gender != undefined &&
			$('#firstname').val() != ''  &&
			$('#lastname').val() != ''  &&
			$('#birthdate').val() != '' &&
			$('#birthplace').val() != '' &&
			$('#fatherfullname').val() != '' &&
			$('#fatherbirthplace').val() != '' &&
			$('#motherfullname').val() != '' &&
			$('#motherbirthplace').val() != '' &&
			$('#relation').val() != '' &&
			$('#contactnumber').val() != '' &&
			$('.marriageaddress').val() != '' &&
			$('.address').val() != '' &&
			$('#file-0b').val() != '' &&
			$('#file-0b').val() != undefined){
				$('#nextButton2').addClass('btn-next')
			}
			else{
				alert('Please complete the form')
			}
		})
		$('#nextButton1').click(function(){
			if(eventDate == ''){
				alert('Please input your desired time')
			}
			else{
				$('#nextButton1').addClass('btn-next')
			}
		})
		$('#radio1').click(function() {
			$('#regular').slideDown();
			$('#special').slideUp();
		});
		$('#radio2').click(function() {
			$('#calendarSpecial').fullCalendar('changeView', 'month')
			$('#special').slideDown();
			$('#regular').slideUp();
		});
		$('#submitButton').click(function() {
			var baptismtype;
			if ($("#radio1").prop("checked")) {
			baptismtype = $("#radio1").val();
			}
			else if($("#radio2").prop("checked")){
			baptismtype = $("#radio2").val();
			}
			if($('.sponsorname').val() != '' &&
			$('.sponsorname').val() != ''){
					var sponsors = $('.sponsorname')
						var formData = new FormData();
					formData.append('baptismtype', baptismtype)
					formData.append('lastname', $('#lastname').val())
					formData.append('firstname', $('#firstname').val())
					formData.append('middlename', $('#middlename').val())
					formData.append('relation', $('#relation').val())
					formData.append('gender',gender)
					formData.append('eventDate',eventDate)
					formData.append('timeStart',timeStart)
					formData.append('address', $('.address').val())
					formData.append('birthday', $('#birthdate').val())
					formData.append('birthplace', $('#birthplace').val())
					formData.append('marriageaddress', $('.parentsmarriage').val())
					formData.append('fatherbirthplace', $('#fatherbirthplace').val())
					formData.append('motherbirthplace', $('#motherbirthplace').val())
					formData.append('fathername', $('#fatherfullname').val())
					formData.append('mothername', $('#motherfullname').val())
					formData.append('contactnumber', $('#contactnumber').val())
					var sponsorname =[];
					for(i=0;i<sponsors.length;i++){
					sponsorname.push($(sponsors[i]).val())
					console.log(sponsorname[i])
					}
					console.log(sponsorname)
					formData.append('sponsorname',sponsorname);
					formData.append('image', $('#file-0b')[0].files[0]);
					$.ajax({
							type:'POST',
							url:'/guest/baptism/form',
							data: formData,
							processData:false,
							contentType:false,
							success: function(data){
								console.log(formData)
								$('#viewModal').modal('show');
								//- $('#voucherButton').click(function(){
								//- 	console.log(data.int_voucherID)
								//- 	window.location=`/guest/voucherEvents?
								//- 	int_voucherID=${data.int_voucherID}`
									
								//- })
								console.log(data.int_voucherID)
								$(document).on(	'click', '#voucherButton', function(){

									$(document).off('click', '#voucherButton')
									$.post('/guest/voucherEvents',{voucherId:data.int_voucherID}).done(data=>{
										$(document).off('click', '#voucherButton')
											function toDataURL(url, callback) {
												var xhr = new XMLHttpRequest();
												xhr.onload = function() {
													var reader = new FileReader();
													reader.onloadend = function() {
													callback(reader.result);
													}
													reader.readAsDataURL(xhr.response);
												};
												xhr.open('GET', url);
												xhr.responseType = 'blob';
												xhr.send();
											}
											toDataURL('/document_templates/voucherTemplate.jpg', function(dataUrl) {
												var docDefinition = {
													pageMargins: [ 0, 0, 0, 0 ],
													content: [
														{
															image: dataUrl,
															width: 610,
															//- height: 100,
														},
														{
														text:`${data.int_voucherID}` + `${data.int_userID}` + `${data.int_eventinfoID}`,
														style: 'styleLabelFill',
														absolutePosition: {x:520, y:28},
														//- text: 'Date: ' + dateRequested,
														},
													],
													styles: {
														styleLabel: {
															font: 'EdwardianScript',
															fontSize:85,
														},
														styleHeader: {
															font: 'OldEnglishText',
															fontSize: 45,
															alignment: 'center',
															margin: [0, 15, 0, 0],
														},
														styleHeader2: {
															font: 'EdwardianScript',
															fontSize: 33,
															alignment: 'center',
															margin: [0, 5, 0, 5],
														},
														styleLabel: {
															font: 'EdwardianScript',
															fontSize: 26,
														},
														styleLabelFill: {
															font: 'Roboto',
															fontSize: 20,
														},
													},
												}
												pdfMake.fonts = {
													Roboto: {
														normal: 'Roboto-Regular.ttf',
														bold: 'Roboto-Medium.ttf',
														italic: 'Roboto-Italic.ttf',
														bolditalics: 'Roboto-MediumItalic.ttf',
													},
													EdwardianScript: {
														normal: 'Edwardian-script-itc-Regular.TTF'
													},
													OldEnglishText: {
														normal: 'Old-english-text-mt-Regular.ttf'
													},
													TimesNewRoman: {
														normal: 'Times-new-roman-Regular.ttf'
													}
												}
												pdfMake.createPdf(docDefinition).open();
												pdfMake.createPdf(docDefinition).download();
											})
									})
							})
							}
					})
			}
			$('#viewModal').modal('show');
			
		});
		$("#addPrincipalSponsor").click(function(event){
				var principal = "<div class='col-md-6 mb-4 pb-3'><div class='input-group'><input type='text' name='sponsorname' class='form-control' required /><div class='input-group-prepend'><span class='btnDelete p-1 input-group-text rounded'><i class='fa fa-trash'></i></span></div></div></div>"
				$(principal).hide().appendTo("#principalSponsor").fadeIn(500);
		});
		$("#principalSponsor").on("click", ".btnDelete", function(event){
			$(this).parent().parent().parent().fadeOut(500, function(){
				$(this).remove();
			});
			event.stopPropagation();
		});
		$("#addAdditionalSponsor").click(function(event){
				var item2 = `
				<div class="col-md-6 px-lg-3 px-md-3 px-sm-0 mt-3">
					<div class="input-group m-0">
						<input class="form-control" type="text" name="sponsorname" placeholder="Enter Full Name"/>
						<div class="input-group-prepend">
							<span class="btnDelete p-1 input-group-text rounded">
								<i class="fa fa-trash"></i>
							</span>
						</div>
					</div>
				</div>`
				$(item2).hide().appendTo("#additionalSponsor").fadeIn(500);
		});
		$("#additionalSponsor").on("click", ".btnDelete", function(event){
			$(this).parent().parent().parent().fadeOut(500, function(){
				$(this).remove();
			});
			event.stopPropagation();
		});
		// for Regular Baptism Date
		var eventDate ='';
		var timeStart ='';
		var timeEnd2 ='';
		var dateNow = new Date()
		var dateNow2 = moment(dateNow,'YYYY-MM-DD hh:mm a').add(7,'days').format('YYYY-MM-DD')
		console.log(eventDate)
		$.get('/guest/baptism/query').done(data=>{
			for(i=0;i<data.length;i++){
			var dateEvent = moment(data[i].date_eventdate).format('MM/DD/YYYY');
			data[i].time_eventstart = moment(data[i].time_eventstart,'hh:mm:ss').format('hh:mm a');
			var time_end = moment(data[i].time_eventstart,'hh:mm:ss').add(1,'hour').format('hh:mm a');
			console.log(time_end)
			console.log(dateEvent)
			console.log(data[i].time_eventstart)
				$('#calendarSpecial').fullCalendar('renderEvent', {
				title: 'OCCUPIED EVENT',
				start: `${dateEvent} ${data[i].time_eventstart}`,
				end: `${dateEvent} ${time_end}`,
				allDay: false,
				color:'#4c2508',
				textColor: "white",
				});
			}
		})
		$('#calendarSpecial').fullCalendar({
			header: {
				left: 'title',
				center: 'agendaDay,month',
				right: 'prev,next today'
			},
			editable: false,
			firstDay: 0,
			selectable: true,
			defaultView: 'month',
			allDaySlot: false,
			selectHelper: true,
			minTime:'8:00:00',
			maxTime:'17:00:00',
			validRange: {
				start: dateNow2
			},
			businessHours: { dow: [1,2,3,4,5,6] },
			selectConstraint: "businessHours",
			select: function(date, jsEvent, view) {
				
				var view = $('#calendarSpecial').fullCalendar('getView');
				console.log(view.name)
				if(view.name == 'agendaDay'){
					eventDate = date.format('YYYY-MM-DD')
					timeStart = date.format('hh:mm a')
					timeEnd1 = date.add(1,'hour').format('YYYY-MM-DD hh:mm a')
					timeEnd2 = moment(timeEnd1).format('hh:mm a')
					console.log(eventDate)
					console.log(timeStart)
					console.log(timeEnd2)
					swal({
						title: 'You have selected this date, are you sure?',
						html: `Date: ${eventDate}  <br>` +
						`Time Start: ${timeStart} <br>` +
						`Time End: ${timeEnd2} <br>`,
						showCancelButton: true,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonClass: 'btn btn-success',
						cancelButtonClass: 'btn btn-danger',
						buttonsStyling: true,   
					}).then((value) => {
						if(value.value) {
							$('#nextButton1').addClass('btn-next')
							$("#calendarRegular").fullCalendar('removeEvents',[1])
							$("#calendarSpecial").fullCalendar('removeEvents',[1])
							swal(
								'Sucess!',
								'Event Date has been set.',
								'success'
							).then((value)=>{
							console.log('DESIRED TIME')
							$('#calendarSpecial').fullCalendar('renderEvent', {
								title: 'DESIRED TIME',
								start: `${moment(eventDate,'YYYY-MM-DD').format('MM/DD/YYYY')} ${timeStart}`,
								end: `${moment(eventDate,'YYYY-MM-DD').format('MM/DD/YYYY')} ${timeEnd2}`,
								allDay: false,
								id:1,
								overlap: false,
								droppable:true
							});
							return value
							console.log(eventDate)
							})
						} else if (
							value.dismiss === swal.DismissReason.cancel
						) {
							eventDate = '';
							timeStart = '';
							timeEnd2 = '';
						}
					})
				}
				else if(view.name == 'month'){
					$('#calendarSpecial').fullCalendar('changeView', 'agendaDay')
					$('#calendarSpecial').fullCalendar('gotoDate', date);
				}
				else{
					return  
				}
			},
			droppable: false,
		});
		var calendar =  $('#calendarRegular').fullCalendar({
			header: {
				left: 'title',
				center: 'agendaDay,month',
				right: 'prev,next today'
			},
			editable: false,
			firstDay: 0,
			selectable: true,
			defaultView: 'month',
			allDaySlot: false,
			validRange: {
				start: dateNow2,
			},
			businessHours: { dow: [0] },
			selectConstraint: "businessHours",
			select: function(date, jsEvent, view) {
				eventDate = date.format('YYYY-MM-DD')
				timeStart = "10:00 am"
				timeEnd2 = "12:00 pm"
				console.log(eventDate)
				swal({
						title: 'You have selected this date, are you sure?',
						html: `Date: ${eventDate}  <br>`,
						showCancelButton: true,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonClass: 'btn btn-success',
						cancelButtonClass: 'btn btn-danger',
						buttonsStyling: true,   
					}).then((value) => {
						if (value.value) {
							$('#nextButton1').addClass('btn-next')
							$("#calendarSpecial").fullCalendar('removeEvents',[1])
							$("#calendarRegular").fullCalendar('removeEvents',[1])
							swal(
								'Sucess!',
								'Event Date has been set.',
								'success'
							).then((value)=>{
							console.log('DESIRED TIME')
							$('#calendarRegular').fullCalendar('renderEvent', {
								title: 'YOUR DESIRED TIME',
								start: `${moment(eventDate,'YYYY-MM-DD').format('MM/DD/YYYY')} ${timeStart}`,
								end: `${moment(eventDate,'YYYY-MM-DD').format('MM/DD/YYYY')} ${timeEnd2}`,
								allDay: false,
								id:1,
								overlap: false,
								droppable:true
							});
							return value
							})
						} else if (
							value.dismiss === swal.DismissReason.cancel
						) {
							eventDate = '';
							timeStart = '';
							timeEnd2 = '';
							console.log(eventDate)
							console.log(timeStart)
							console.log(timeEnd2)
						}
					})
			}
		});
		
