extends ../../../../templates/guests
block main
	style.
		@media screen and (max-width: 576px) {
			.col-md-4, .col-md-6, .col-md-9 {
					padding-left: 0;
					padding-right: 0;
			}
			.form-wizard-step {
					padding-bottom: 10px !important;
			}
		}
		#header-style-1 {
			background-image: url(/imgchurch/funeral.jpg)
		}
		.form-wizard-tolal-steps-3 .form-wizard-step {
			width: 49.33%;
		}
		.hidden {
			display:none;
		}
		.form-control {
			margin-bottom: 0;
		}
	#headers
		#header-style-1
			.container
				.header-caption
					.row
						.col-md-12.header-content
							h3.header-title.animated.fadeInDown.invisible
								span.text-primary Helium -
								| Bootstrap 4 UI Kit
							h5.header-text.animated.fadeIn.invisible
								| Lorem ipsum dolor sit amet, consectetuer adipiscing elit<br>Lorem ipsum dolor sit amet, consectetuer.</h5>
							//- a.page-scroll.btn.btn-lg.btn-default-filled.animated.fadeInUp.invisible(href="#") Download Now
							//- a.page-scroll.btn.btn-lg.btn-common.animated.fadeInUp.invisible(href="#") Explore
		#raised-section.main.main-raised
			section.form-box
				.container
					.row
						.col-md-12.form-wizard.shadow3
							form
								// Form Wizard
								//- form(action="/guest/funeral/form" enctype="multipart/form-data" method="post" data-toggle='validator')
								h3 Funeral Blessing Form
								p.mb-2 Fill all form fields
								.form-wizard-steps.form-wizard-tolal-steps-3
									.form-wizard-progress
											.form-wizard-progress-line(data-now-value='12.25' data-number-of-steps='3' style='width: 12.25%;')
									// Step 1
									.form-wizard-step.active
											.form-wizard-step-icon
													i.fa.fa-calendar(aria-hidden='true')
											p.d-none.d-sm-block Schedule Date
									// Step 1
									// Step 2
									.form-wizard-step
											.form-wizard-step-icon
													i.fa.fa-info(aria-hidden='true')
											p.d-none.d-sm-block Blessing Details
									// Step 2
								// Form Step 1
								fieldset
									h4
										.d-none.d-sm-inline Appointment
										span Step 1 - 2
										h5.label-control Desired Date
											.text-danger.d-inline  *
										.row
											.col-md-8.mx-lg-auto.mx-sm-left.my-lg-auto.my-sm-left.text-lg-center.text-sm-left
												h5
													#special
														.form-group
															.container
																#calendarFuneral
										.learn-more.pull-right
													button#next.btn(type='button') Next
								// Form Step 1
								// Form Step 2
								fieldset
									h4
										.d-none.d-sm-inline Blessing Details:
										span Step 2 - 2
										input.form-control#userID(type='hidden' name='userID' value=`${user.int_userID}`)
										input.form-control#eventID(type='hidden' name='eventID' value=`${eventid}`)
										h6.label-control Name of the deceased
											.text-danger.d-inline  *
										.row
											.col-md-4.px-lg-3.px-md-0.px-sm-0
												.form-group.pt-0
													input.form-control#lastname(type='text' placeholder="Last Name *" name='lastname' )
											.col-md-4.p-lg-0.px-md-3.px-sm-0
												.form-group.pt-0
													input.form-control#firstname(type='text' placeholder="First Name *" name='firstname' )
											.col-md-4.px-lg-3.px-md-0.px-sm-0
												.form-group.pt-0
													input.form-control#middlename(type='text' placeholder="Middle Name" name='middlename')
										.row
											.col-md-4.px-lg-3.px-md-0.px-sm-0
												.form-group.m-0
													h6.label-control Gender
														.text-danger.d-inline  *
														.form-check.ml-3
															label.form-check-label
																input.form-check-input#male(type="radio" name="gender" value="Male" checked)
																| Male
																span.circle
																	span.check
														.form-check
															label.form-check-label.ml-3
																input.form-check-input#female(type="radio" name="gender" value="Female")
																| Female
																span.circle
																	span.check
											.col-md-4.p-lg-0.px-md-3.px-sm-0
												.form-group
													h6.label-control Birthday
														.text-danger.d-inline  *
													input.birthday.form-control#birthday(type='date' name='birthday'  data-error='Please enter your birthday')
													p
													span.emsg.hidden
														i.fa.fa-times.text-danger(style="font-size:20px" aria-hidden="true")
														|  Please Enter Your Birthday.
													span.emsgcorrect.hidden
														i.fa.fa-check.text-success(style="font-size:20px" aria-hidden="true")
											.col-md-4.px-lg-3.px-md-0.px-sm-0
												.form-group
													h6.label-control Birthplace
														.text-danger.d-inline  *
													input.form-control#birthplace(type='text' name='birthplace' placeholder="Ex. Payatas, Quezon City" )
										.row
											.col-md-6.px-lg-3.px-md-0.px-sm-0
												.form-group
													h6.label-control Relationship with the Deceased
														.text-danger.d-inline  *
													select#relation(type="text" name='relation' )
														option(selected="" value="" disabled) Choose..
														option Aunt/Uncle
														option BF/GF
														option Child
														option Friend
														option Grandchild
														option Grandparent
														option Nephew/Niece
														option Parent
														option Spouse
														option Sibling
											.col-md-6.pl-lg-0.px-md-0.pl-md-3.px-sm-0.pr-lg-3
												.form-group
													h6(for='address') Address
														.text-danger.d-inline  *
													textarea#address.form-control(rows='1' name='address' placeholder="Ex. Urban, Bgy. Payatas B 1119 QC" )
										.row
											//- .col-lg-6.col-md-12.px-lg-0.px-md-3.px-sm-0
											.col-lg-6.col-md-12.pr-lg-0.px-md-3.px-sm-0
												.form-group
													h6.label-control Cause of Death
														.text-danger.d-inline  *
													textarea#details.form-control(rows='3' name='details' placeholder="Please enter the cause of death")
												.form-group
													- if(eventid == 4)
														h6.label-control Place where the will happen
															.text-danger.d-inline  *
														.ml-4
															.form-check
																label.form-check-label
																	input.exampleRadios1.form-check-input#blessingloc1(type="radio" name="venue" value="sameaddress" checked)
																	| Same as his/her address
																	span.circle
																		span.check
															//- .form-check
															//- 	label.form-check-label
															//- 		input.radioup.form-check-input#blessingloc2(type="radio" name="venue" value="INLPP")
															//- 		| INLPP
															//- 		span.circle
															//- 			span.check
															.form-check
																label.form-check-label
																	input.exampleRadios3.form-check-input#blessingloc3(type="radio" name="venue" value="other")
																	| Other
																	span.circle
																		span.check
																#textarea2.form-group
																	h6.label-control Enter Complete Address
																		.text-danger.d-inline  *
																	textarea.form-control#othervenue.venuevalidation(placeholder="Ex. Urban, Bgy. Payatas B 1119 QC" rows="2" name='othervenue')
																	p
																		span.emsgvenue.hidden
																			i.fa.fa-times.text-danger(style="font-size:20px" aria-hidden="true")
																			|  Please Enter Venue.
																		span.emsgcorrectvenue.hidden
																			i.fa.fa-check.text-success(style="font-size:20px" aria-hidden="true")
											.col-md-6.px-lg-3.px-md-3.px-sm-0
												.form-group
													h6.label-control Birth Certificate
														.text-danger.d-inline  *
													input#file-0b.file(type='file',accept='image/*',name="image" onchange="validateFileType()")
													label
													//- .col-md-6.mt-2.px-lg-3.px-md-3.px-sm-0
													//- 	h6.label-control Death Certificate
													//- 	input(type='file', name='deathCertificate' accept='image/*' required)
									.learn-more.pull-right
										button.btn.std-btn.btn-secondary.btn-previous.m-0(type='button') Prev
										button.btn.btn-submit#submitButton(type='button'  value= `${user.int_userID}`) Submit
							input#errChecker(type='text' hidden)
block addjs
	script.
		$('#textarea2').hide();
		$('#exampleRadios1').click(function() {
			$('#textarea2').slideUp();
		});
		$('#blessingloc2').click(function() {
			$('#textarea2').slideUp();
		});
		$('.exampleRadios3').click(function() {
			$('#textarea2').slideDown();
		});
		function validateFileType(){
			var fileName = document.getElementById("file-0b").value;
			console.log(fileName)
			var idxDot = fileName.lastIndexOf(".") + 1;
			var extFile = fileName.substr(idxDot, fileName.length).toLowerCase();
			if (extFile=="jpg" || extFile=="jpeg" || extFile=="png"){
				//TO DO
			}else{
				alert("Only jpg/jpeg and png files are allowed!");
				$("#file-0b").val(null)
			}
		}
		$(document).ready(function(){
				validateForm()
				console.log($('#eventID').val())
					$('#next').click(function(){
					if(eventDate == ''){
						swal({
							title: "Please schedule your date",
							text: "You haven't chosen your desired schedule yet",
							type: 'warning',
							confirmButtonColor: '#3085d6',
							confirmButtonText: 'OK'
						})
					}
					else{
						$('#next').addClass('btn-next')
					}
				})

				$('#submitButton').click(function(){
							var $addressvalidation = /^([a-zs0-9-,. ]{8,})+$/i;
				if(
					$('#firstname').val() == ''  ||
					$('#lastname').val() == ''  ||
					$('#birthday').val() == '' ||
					$('#birthplace').val() == '' ||
					$('#relation').val() == '' ||
					$('#address').val() == '' ||
					$('#details').val() == '' ||
					$('#file-0b').val() == '' ||
					$('#file-0b').val() == undefined ||
					$('.exampleRadios3').prop("checked") && !$('#othervenue').val().match($addressvalidation)
				){
						swal({
						title: "Form is not complete/valid yet",
						text: "Please fill out and validate all the required fields",
						type: 'warning',
						confirmButtonColor: '#3085d6',
						confirmButtonText: 'OK'
					})
				}
				else{
					
						//- $(this).attr('disabled', 'disabled');
						var idNow = $(this).val();
						console.log(idNow)
						$.post('/index/funeral/query',{
							firstname: $('#firstname').val(),id:idNow
						}).done(data=>{
							if($('#male').prop("checked")){
								gender= $('#male').val()
							}
							if($('#female').prop("checked")){
								gender= $('#female').val()
							}
							if($('#blessingloc1').prop("checked")){
								venue= $('#address').val(),
								blessloc='1'
							}
							if($("#blessingloc2").prop("checked")){
								venue= 'Ina ng Lupang Pangako',
								blessloc='2'
							}
							if($("#blessingloc3").prop("checked")){
								venue= $('#othervenue').val(),
								blessloc='1'
							}else {
								venue = 'Ina ng Lupang Pangako'
								blessloc='2'
							}
								var formData= new FormData();
								formData.append('desireddate1', eventDate),
								formData.append('desiredtime1', timeStart),	
								formData.append('desiredtimeend', timeEnd2),	
								formData.append('userID', $('#userID').val()),
								formData.append('lastname', $('#lastname').val()),
								formData.append('firstname', $('#firstname').val()),
								formData.append('middlename', $('#middlename').val()),
								formData.append('gender', gender),
								formData.append('venue', venue),
								formData.append('blessloc', blessloc),
								formData.append('birthday', $('#birthday').val()),
								formData.append('birthplace', $('#birthplace').val()),
								formData.append('address', $('#address').val()),
								formData.append('details', $('#details').val()),
								formData.append('relation', $('#relation').val()),
								formData.append('image', $('#file-0b')[0].files[0]);
							$.ajax({
								type: 'POST',
								url: '/index/funeral/form',
								data: formData,
								processData:false,
								contentType:false,
								success: function(data){
									swal({
										title: "Success",
										text: 'Your request has been submitted; however, the time is still tentative. We will notify you once the scheduled time is changed. Thank you and God bless.',
										icon: 'success',
										buttons:{
											Okay:'okay'
										}
									}).then((value)=>{
										window.location='/index'
									})
								}

							})

						})
							

					}
					})		
		
		var dateNow2
		var eventDate ='';
		var timeStart ='';
		var timeEnd2 ='';
		var dateNow = new Date()
		var dateNow2;
		var gender;
		$.get('/guest/funeral/utilities/query').done(data=>{
			console.log(data[0].int_reservationmindays)
			dateNow2 = moment(dateNow,'YYYY-MM-DD hh:mm a').add(data[0].int_reservationmindays,'days').format('YYYY-MM-DD')
			$('#calendarFuneral').fullCalendar({
				header: {
				left: 'title',
				center: 'agendaDay,month',
				right: 'prev,next today'
				},
				editable: false,
				firstDay: 0,
				selectable: true,
				defaultView: 'month',
				allDaySlot: false,
				selectHelper: true,
				minTime:data[0].time_availablestart,
				maxTime:data[0].time_availableend,
				validRange: {
					start: dateNow2
				},
				businessHours: { dow: [0,1,2,3,4,5,6] },
				selectConstraint:"businessHours",
				select:function(date,jsEvent,view){
				var view = $('#calendarFuneral').fullCalendar('getView');
				console.log(view.name)
				if(view.name == 'agendaDay'){
					eventDate = date.format('YYYY-MM-DD')
					timeStart = date.format('hh:mm a')
					timeEnd1 = date.add(1,'hour').format('YYYY-MM-DD hh:mm a')
					timeEnd2 = moment(timeEnd1).format('hh:mm a')
					console.log(eventDate)
					console.log(timeStart)
					console.log(timeEnd2)
					swal({
						title: 'You have selected this date, are you sure?',
						html: `Date: ${eventDate}  <br>` +
						`Time Start: ${timeStart} <br>` +
						`Time End: ${timeEnd2} <br>`,
						showCancelButton: true,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonClass: 'btn btn-success',
						cancelButtonClass: 'btn btn-danger',
						buttonsStyling: true,   
					}).then((value) => {
						if(value.value) {
							$("#calendarFuneral").fullCalendar('removeEvents',[1])
							swal(
								'Sucess!',
								'Event Date has been set.',
								'success'
							).then((value)=>{
							console.log('DESIRED TIME')
							$('#calendarFuneral').fullCalendar('renderEvent', {
								title: 'DESIRED TIME',
								start: `${moment(eventDate,'YYYY-MM-DD').format('MM/DD/YYYY')} ${timeStart}`,
								end: `${moment(eventDate,'YYYY-MM-DD').format('MM/DD/YYYY')} ${timeEnd2}`,
								allDay: false,
								id:1,
								overlap: false,
								droppable:true
							});
							return value
							console.log(eventDate)
							})
						} else if (
							value.dismiss === swal.DismissReason.cancel
						) {
							eventDate = '';
							timeStart = '';
							timeEnd2 = '';
						}
					})
				}
				else if(view.name == 'month'){
					$('#calendarFuneral').fullCalendar('changeView', 'agendaDay')
					$('#calendarFuneral').fullCalendar('gotoDate', date);
				}
				else{
					return  
				}
				}
			})
		})
			if($('#eventID').val() == 7){

			$.post('/guest/funeral/query').done(data=>{
			console.log(data.queries)
			for(i=0;i<data.queries.length;i++){
			var dateEvent = moment(data.queries[i].date_eventdate).format('MM/DD/YYYY');
			var time_start = data.queries[i].time_eventstart = moment(data.queries[i].time_eventstart,'hh:mm:ss').format('hh:mm a');
			var time_end = moment(data.queries[i].time_eventstart,'hh:mm:ss').add(1,'hour').format('hh:mm a');
			//- console.log(time_end)
			//- console.log(dateEvent)
			//- console.log(data.queries[i].time_eventstart)
			//- console.log(data.queries[i].char_approvalstatus)
				$('#calendarFuneral').fullCalendar('renderEvent', {
				title: 'OCCUPIED',
				start: `${dateEvent} ${time_start}`,
				end: `${dateEvent} ${time_end}`,
				allDay: false,
				color:'#4c2508',
				textColor: "white",
				});
			}
			})
			}
			else{
			$.get('/guest/funeral/query/checksched').done(data=>{
				//- console.log("schedule length: " + data.schedules.length)
				//- console.log("priest length: "+ data.priestLength.length)
				let total = 0;
				for(let i=0;i<data.schedules.length;i++){
					for(let j=0;j<data.priestLength.length;j++){
						let x = data.priestLength.length - 1
						console.log("schedule: " + data.schedules[i].date_eventdate + " " + data.schedules[i].time_eventstart)
						console.log("priest number: " + data.priestLength[j].int_priestID)
						let currentDate = data.schedules[i].date_eventdate
						let currentTime = data.schedules[i].time_eventstart
						$.post('/guest/funeral/query/checksched2',{
							priestid:data.priestLength[j].int_priestID,
							eventdate:data.schedules[i].date_eventdate,
							eventtime:data.schedules[i].time_eventstart
						}).done(data=>{
							console.log(data.shit)
							if(data.shit == 1){
								total+=1;
								console.log("priest not avail")
							}
							if(total == x){
								
							}
							if(x == j){
								console.log(total,'total')
								total = 0
							}
						})
					}
				}
			})
		}
		})


		$('#birthday').on('keypress keydown keyup focus focusout',function(e){
			if ($(this).val().length == 0) {
				// there is a mismatch, hence show the error message
					$('.emsgcorrect').addClass('hidden');
					$('.emsg').removeClass('hidden');
					$('.emsg').show();
				}
			else{
				// else, do not display message
				$('.emsg').addClass('hidden');
				$('.emsgcorrect').removeClass('hidden');
				$('.emsgcorrect').show();
			}
			e.stopPropagation();
		});

			var $regexname = /^([a-zs0-9-, ]{8,})+$/i;
			$('.venuevalidation').on('keypress keydown keyup',function(e){
				if (!$(this).val().match($regexname)) {
					// there is a mismatch, hence show the error message
						$('.emsgcorrectvenue').addClass('hidden');
						$('.emsgvenue').removeClass('hidden');
						$('.emsgvenue').show();
					}
				else{
					// else, do not display message
					$('.emsgvenue').addClass('hidden');
					$('.emsgcorrectvenue').removeClass('hidden');
					$('.emsgcorrectvenue').show();
				}
				e.stopPropagation();
			});

			//- var $regexname1 = /^([a-zs0-9-, ]{8,})+$/i;
			//- $('.venuevalidation').on('keypress keydown keyup',function(e){
			//- 	if (!$(this).val().match($regexname1)) {
			//- 		// there is a mismatch, hence show the error message
			//- 			$('.emsgcorrectvenue1').addClass('hidden');
			//- 			$('.emsgvenue1').removeClass('hidden');
			//- 			$('.emsgvenue1').show();
			//- 		}
			//- 	else{
			//- 		// else, do not display message
			//- 		$('.emsgvenue1').addClass('hidden');
			//- 		$('.emsgcorrectvenue1').removeClass('hidden');
			//- 		$('.emsgcorrectvenue1').show();
			//- 	}
			//- 	e.stopPropagation();
			//- });

		function readURL(input) {
			if (input.files && input.files[0]) {
				var reader = new FileReader();

				reader.onload = function (e) {
					$('#req').attr('src', e.target.result);
				}

				reader.readAsDataURL(input.files[0]);
			}
		}
				
		$("#file-0b").change(function () {
			readURL(this);
		});

		function validateForm(){
			$('form').formValidation({
				framework: 'bootstrap',
				icon: {
					valid: 'fa fa-check',
					invalid: 'fa fa-times',
					validating: 'fa fa-spinner'
				},
				fields: {
					lastname: {
						validators: {
								notEmpty: {
										message: `Please Enter Your Last Name`
								},
								regexp: {
									regexp: /^([a-zs ]{2,})+$/i,
									message: 'Only Aphabetical Characters, Minimum of 2.'
								},
						}
					},
					firstname: {
						validators: {
								notEmpty: {
										message: `Please Enter Your Last Name`
								},
								regexp: {
									regexp: /^([a-zs ]{2,})+$/i,
									message: 'Only Aphabetical Characters, Minimum of 2.'
								},
						}
					},
					middlename: {
						validators: {
							regexp: {
								regexp: /^([a-zs ]{2,})+$/i,
								message: 'Only Aphabetical Characters, Minimum of 2.'
							},
						}
					},
					relation: {
						validators: {
						notEmpty: {
										message: `Please Enter Your Relationship with the Ill`
								},
							}
						},
					//- birthday: {
					//- 	validators: {
					//- 	notEmpty: {
					//- 					message: `Please Enter Your Birthday`
					//- 			},
					//- 		}
					//- 	},
					birthplace: {
							validators: {
									notEmpty: {
									message: `Please Enter Your Birthplace`
									},
									regexp: {
										regexp: /^([a-zs ]{2,})+$/i,
										message: 'Only Aphabetical Characters, Minimum of 2.'
									},
								}
							},
					address: {
							validators: {
									notEmpty: {
									message: `Please Enter Your Address`
									},
									regexp: {
										regexp: /^([a-zs0-9-,. ]{8,})+$/i,
										message: 'Please Enter A Valid Address'
									},
								}
							},
					details: {
							validators: {
									notEmpty: {
									message: `Please Enter Cause of Death`
									},
									regexp: {
										regexp: /^([a-zs ]{6,})+$/i,
										message: 'Only Aphabetical Characters, Minimum of 6.'
									},
								}
							},
					image: {
							validators: {
								notEmpty: {
									message: `Please Enter Birth Certificate`
									},
								}
							},
					//- venue: {
					//- 		validators: {
					//- 				regexp: {
					//- 					regexp: /^([a-zs ]{6,})+$/i,
					//- 					message: 'Only Aphabetical Characters, Minimum of 6.'
					//- 				},
					//- 			}
					//- 		},
					},
				})
			.on('err.field.fv', function(e, data) {
				// Get the first invalid field
				var invalidFields = data.fv.getInvalidFields().length;
				$('#errChecker').val(invalidFields)
			})
			.on('success.field.fv', function(e, data) {
				// Get the first invalid field
				var invalidFields = data.fv.getInvalidFields().length;
				$('#errChecker').val(invalidFields)
			});
		}