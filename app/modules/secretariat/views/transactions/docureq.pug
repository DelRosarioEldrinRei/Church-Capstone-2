extends ../../../../templates/secretariat
block prepend main
	style.
		.dataTables_wrapper {
			overflow: visible !important;
		}
		.tableModal {
		font-family: arial, sans-serif;
		border-collapse: collapse;
		width: 100%;
		}

		.tdModal{
			border: 2px solid #dddddd;
			text-align: left;
			padding: 12px;
		}
		.shadow3 {
			box-shadow: 0 19px 38px rgba(0,0,0,0.30), 0 15px 12px rgba(0,0,0,0.22);
		}

		body > div.mfp-wrap.mfp-close-btn-in.mfp-auto-cursor.mfp-with-zoom.mfp-ready > div {
			z-index: 9999 !important;
		}

		.mfp-with-zoom .mfp-container,
		.mfp-with-zoom.mfp-bg {
			opacity: 0;
			-webkit-backface-visibility: hidden;
			/* ideally, transition speed should match zoom duration */
			-webkit-transition: all 0.3s ease-out;
			-moz-transition: all 0.3s ease-out;
			-o-transition: all 0.3s ease-out;
			transition: all 0.3s ease-out;
			z-index: 99999;
		}

		.mfp-image, .mfp-container, .mfp-ready, .mfp-image-holder, .mfp-content, .mfp-preloader, .mfp-figure {
			z-index: 99999;
		}

		.mfp-with-zoom.mfp-ready .mfp-container {
			opacity: 1;
		}
		.mfp-with-zoom.mfp-ready.mfp-bg {
			opacity: 0.8;
		}

		.mfp-with-zoom.mfp-removing .mfp-container,
		.mfp-with-zoom.mfp-removing.mfp-bg {
		opacity: 0;
		}
	#wrap
	div(style='clear:both')
	.content
		.container-fluid
			.row
				.col-lg-12.col-md-12
						.card.shadow
								.card-header.card-header-primary(style='background:#367587; color:white')
										h4.card-title(style='background:#367587; color:white') Document Requests
										input#toggleInput(type="hidden" value=0)
								.card-body.table-responsive
									table.dataTable.table.table-hover
											thead.text-primary
													th ID
													th Document Name
													th Document type
													th Date Requested
													th Status
													th.text-center(style=" width:11rem") Actions
											tbody
													each request in requests
														tr
															td=request.int_requestID
															td=request.var_doclastname + ", " + request.var_docfirstname
															td=request.var_documenttype
															td=request.date_docurequested
															td=request.char_docustatus
															//- td.td-actions.text-center
															//-     button.btn.btn-info.viewButton(type='button',rel='tooltip',value=`${request.int_requestID}`)
															//-         i.ti-user
															//-     | &nbsp;
															//-     button.btn.btn-primary.updateButton(type='button',rel='tooltip',value=`${request.int_requestID}`)
															//-         i.ti-pencil
															td.td-actions.text-center
																button.btn.btn-primary.actionButton(type='button' value=`${request.int_requestID}`)
																	i.ti-settings
																		#toolbar-options.hidden
																			a.viewButton(href='#')
																				i.ti-file(style="color:white;")
																			a.updateButton(href='#')
																				i.ti-pencil(style="color:white;")
	#viewModal.modal.fade(tabindex="-2" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true")
			.modal-dialog.modal-lg(role="document")
				.modal-content
					.modal-header(style='background:#367587; color:white')
						h5.modal-title(style='background:#367587; color:white') Document Request
						button.close.text-white(type='button', data-dismiss='modal', aria-label='Close')
							span(aria-hidden='true') ×
					.modal-body#documentAppend
					.modal-footer.mx-auto
						button.btn.btn-outline.btn-primary.pull-right#generateButton Generate
	#updateModal.modal.fade(tabindex="-2" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true")
			.modal-dialog.modal-lg(role="document")
				.modal-content
					.modal-header(style='background:#367587; color:white')
						h5.modal-title Update Request
						button.close.text-white(type='button', data-dismiss='modal', aria-label='Close')
							span(aria-hidden='true') ×
					.modal-body#updateAppend
					.modal-footer.mx-auto
						button.btn.btn-primary#updateSubmitButton(type="button") Update						
	#myModal.modal(tabindex='-1', role='dialog', aria-labelledby='exampleModalLabel', aria-hidden='true')
		button.close(type='button', data-dismiss='modal', aria-label='Close')
			span(aria-hidden='true') ×
		img.modal-content1#imgReq
		
block addjs
	script(type='text/javascript').
		$(document).ready(function(){
			$('.actionButton').click(function(){
				idNow = $(this).val();
				console.log(idNow)
			});
			$('.viewButton').click(function(){
				console.log(idNow)
				$.post('/secretariat/transaction-documentrequest/query',{id:idNow})
					.done(data =>{
					var dateRequested = moment(data.date_docurequested).format('MM/DD/YYYY');
					$('#documentAppend').append(`
						<form>
							<label>Name of the Child:</label>
							<div class="form-row mx-1">
								<div class="form-group col-md-6">
									<label>Last Name:</label>
									<input type="text" class="form-control" placeholder="Last Name" value="${data.var_doclastname}" disabled>
								</div>
								<div class="form-group col-md-6">
									<label>First Name</label>
									<input type="text" class="form-control" placeholder="First Name" value="${data.var_docfirstname}" disabled>
								</div>
							</div>
							<div class="form-row">
								<div class="form-group col-md-6">
									<label>Baptism Date:</label>
									<input type="text" class="form-control" placeholder="Date of Baptism" value="${dateRequested}" disabled>
								</div>
								<div class="form-group col-md-6">
									<label>Purpose:</label>
									<input type="text" class="form-control" placeholder="Purpose of Request" value="${data.text_purpose}" disabled>
								</div>
							</div>
							<div class="form-group">
								<label>Requirements: <strong> ${data.var_reqname} </strong></label>
								<img id="myImg" class="img-responsive mt-1 ml-3 shadow d-block" alt ="${data.var_reqname}" src="${data.var_reqpath}" style="max-height:250px;">
							</div>

						</form>
					`)
					$('#viewModal').modal('show');
					$('#myModal').on('shown.bs.modal',function(){
						$('#toggleInput').val(0)
					})
					$('#cancelButton').css('display', 'block');
					$('#viewModal').on('hidden.bs.modal',function(){
						$('#documentAppend').empty()
					})
					$('#myImg').click(function(){
						$('#myModal').modal('show');
						$("#imgReq").attr("src",`${data.var_reqpath}`);
						$('#toggleInput').val(1)
					});
					$('#myModal').on('shown.bs.modal',function(){
						$('#toggleInput').val(1)
					})
					$('#myModal').on('hidden.bs.modal',function(){
						$('#toggleInput').val(0)
					})
					$(document).on('keypress',function(e) {
						if (e.keyCode == 27) {
							console.log($('#toggleInput').val())
							if($('#toggleInput').val() == 1){
								$('#myModal').modal('hide')
								$('#toggleInput').val(0)
							}
							else if($('#toggleInput').val() == 0){
								$('#viewModal').modal('hide')
								$('#toggleInput').val(0)
							}
						}
					});
					$(document).on(	'click', '#generateButton', function(){
						$(document).off('click', '#generateButton')
						function toDataURL(url, callback) {
							var xhr = new XMLHttpRequest();
							xhr.onload = function() {
								var reader = new FileReader();
								reader.onloadend = function() {
								callback(reader.result);
								}
								reader.readAsDataURL(xhr.response);
							};
							xhr.open('GET', url);
							xhr.responseType = 'blob';
							xhr.send();
						}
						toDataURL('/document_templates/baptism_certificate.jpg', function(dataUrl) {
						var fullName = data.var_doclastname + ', ' + data.var_docfirstname;
						var dateRequested = moment(data.date_docurequested).format('MM/DD/YYYY');
							var docDefinition = {
								pageMargins: [ 0, 0, 0, 0 ],
								content: [
									{
										image: dataUrl,
										width: 610,
										//- height: 100,
									},
									{
									text: fullName,
									style: 'styleLabelFill',
									absolutePosition: {x:125, y:247},
									//- text: 'Date: ' + dateRequested,
									},
								],
								styles: {
									styleLabel: {
										font: 'EdwardianScript',
										fontSize:85,
									},
									styleHeader: {
										font: 'OldEnglishText',
										fontSize: 45,
										alignment: 'center',
										margin: [0, 15, 0, 0],
									},
									styleHeader2: {
										font: 'EdwardianScript',
										fontSize: 33,
										alignment: 'center',
										margin: [0, 5, 0, 5],
									},
									styleLabel: {
										font: 'EdwardianScript',
										fontSize: 26,
									},
									styleLabelFill: {
										font: 'EdwardianScript',
										fontSize: 35,
									},
								},
							}
							pdfMake.fonts = {
								Roboto: {
									normal: 'Roboto-Regular.ttf',
									bold: 'Roboto-Medium.ttf',
									italic: 'Roboto-Italic.ttf',
									bolditalics: 'Roboto-MediumItalic.ttf',
								},
								EdwardianScript: {
									normal: 'Edwardian-script-itc-Regular.TTF'
								},
								OldEnglishText: {
									normal: 'Old-english-text-mt-Regular.ttf'
								},
								TimesNewRoman: {
									normal: 'Times-new-roman-Regular.ttf'
								}
							}
							pdfMake.createPdf(docDefinition).open();
							
						})
					})
				})
			})
			$('.updateButton').click(function(){
				console.log(idNow)
				$.post('/secretariat/transaction-documentrequest/update/query',{id:idNow}).done(data =>{
					console.log(data)
					$('#updateAppend').append(`
					<form>
						<input id="docuid" type="hidden" value="${data.int_requestID}"></input>
						<input id="userid" type="hidden" value="${data.int_userID}"></input>
						<input id="docustatus" type="hidden" value="${data.char_docustatus}"></input>
						<input id="reqid" type="hidden" value="${data.int_requirementdocumentID}"></input>
						<div class="form-row">
							<div class="form-group col-md-6">
								<label>Current Document Status:</label>
								<input type="text" class="form-control" value="${data.char_docustatus}" disabled>
							</div>
							<div class="form-group col-md-6">
								<label>Current Requirement Status:</label>
								<input type="text" class="form-control" value="${data.char_reqstatus}" disabled>
							</div>
						</div>
						<div class="form-row">
							<div class="form-group col-md-6">
								<label>Current Payment Status:</label>
								<input type="text" class="form-control" value="${data.char_paymentstatus}" disabled>
							</div>
							<div class="form-group col-md-6">
								<label>Fee:</label>
								<input type="text" class="form-control" value="&#8369;${data.dbl_docuprice}" disabled>
							</div>
						</div>
						<div class="form-row">
							<div class="form-group col-md-6">
								<label>Update Payment Status:</label>
								<select id="reqstatus" class="form-control">
								</select>
							</div>
							<div class="form-group col-md-6">
								<label>Update Fee Status:</label>
								<select id="paystatus" class="form-control">
								</select>
							</div>
						</div>
					</form>
					`)
					if(data.char_reqstatus == "Pending"){
					document.getElementById("paystatus").disabled=true;
					$('#reqstatus').append(`
					<option selected="selected">Pending</option>
					<option>Incomplete</option>
					<option>Approved</option>
					`)
					if(data.char_paymentstatus == "Paid"){
					$('#paystatus').append(`
					<option selected="selected">Paid</option>
					<option>Unpaid</option>
					`)
					}
					else if(data.char_paymentstatus == "Unpaid"){
					$('#paystatus').append(`
					<option>Paid</option>
					<option selected="selected">Unpaid</option>
					`)
					}
					}
					else if(data.char_reqstatus == "Approved"){
					document.getElementById("paystatus").disabled=false;
					$('#reqstatus').append(`
					<option>Pending</option>
					<option>Incomplete</option>
					<option selected="selected">Approved</option>
					`)
					if(data.char_paymentstatus == "Paid"){
					$('#paystatus').append(`
					<option selected="selected">Paid</option>
					<option>Unpaid</option>
					`)
					}
					else if(data.char_paymentstatus == "Unpaid"){
					$('#paystatus').append(`
					<option>Paid</option>
					<option selected="selected">Unpaid</option>
					`)
					}
					}
					else if(data.char_reqstatus == "Incomplete"){
					document.getElementById("paystatus").disabled=true;
					$('#reqstatus').append(`
					<option>Pending</option>
					<option selected="selected">Incomplete</option>
					<option>Approved</option>
					
					`)
					if(data.char_paymentstatus == "Paid"){
					$('#paystatus').append(`
					<option selected="selected">Paid</option>
					<option>Unpaid</option>
					`)
					}
					else if(data.char_paymentstatus == "Unpaid"){
					$('#paystatus').append(`
					<option>Paid</option>
					<option selected="selected">Unpaid</option>
					`)
					}
					}
					
					$('#updateModal').modal('show');
					$('#updateModal').on('hidden.bs.modal',function(){
						$('#updateAppend').empty()
					})
					$('#cancelButton').click(function(){
						$('#updateAppend').empty();
					})
					$('#updateSubmitButton').click(function(){
						console.log($('#reqstatus').val())
						console.log('clicked')
						swal({
						title:'Are You Sure?', 
						text:'You want to update the Status of the Request?', 
						type:'warning',
						showCancelButton: true,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonText: 'Confirm'
						}).then((result)=>{
						if(result.value){
						console.log($('#reqstatus').val())
						$.post('/secretariat/transaction-documentrequest/update',{
						docustatus:$('#docustatus').val(),
						docuid:$('#docuid').val(),
						reqid:$('#reqid').val(),
						reqstatus:$('#reqstatus').val(),
						payid:$('#payid').val(),
						paystatus:$('#paystatus').val(),
						userid:$('#userid').val()
						})
						.done(data=>{
							if(data){
								swal({
								title:'Success',
								text:'Status updated', 
								type:'success'
								}).then(function(){
									location.reload();
								})
								$('#updateModal').modal('hide');
								$('#updateAppend').empty();
							}
						})
						}
					})
					})
				})
			})
			
		});
