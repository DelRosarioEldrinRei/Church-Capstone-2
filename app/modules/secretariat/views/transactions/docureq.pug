extends ../../../../templates/secretariat
block prepend main
	#wrap
	div(style='clear:both')
	.content
		.container-fluid
			.row
				.col-lg-12.col-md-12
						.card
								.card-header.card-header-primary
										h4.card-title Document Requests
										
								.card-body.table-responsive
										table.table.table-hover
												thead.text-primary
														th ID
														th Document Name
														th Document type
														th Date Requested
														th Status
														th.text-center(style=" width:120px") Actions
												tbody
														each request in requests
															tr
																td=request.int_requestID
																td=request.var_doclastname + ", " + request.var_docfirstname
																td=request.var_documenttype
																td=request.date_docurequested
																td
																	select.form-control
																		option=request.char_docustatus
																td.td-actions.text-center
																	button.btn.btn-info.viewButton(type='button',rel='tooltip',value=`${request.int_requestID}`)
																		i.ti-user
	#viewModal.modal.fade(tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true")
			.modal-dialog.modal-lg(role="document")
				.modal-content
					.modal-header
						h5.modal-title Document Request
						button.close(type='button', data-dismiss='modal', aria-label='Close')
							span(aria-hidden='true') Ã—
						//- h4.modal-title Warning
					.modal-body#documentAppend
					.modal-footer
						button.btn.btn-outline.btn-secondary.pull-left#cancelButton(type='button', data-dismiss='modal') Close
						//- button.btn.btn-outline.pull-right Update
						button.btn.btn-outline.btn-primary.pull-right#generateButton Generate
	block addjs
		script.
			$(document).ready(function(){
				$('.viewButton').click(function(){
					var idNow = $(this).val();
					console.log(idNow)
					$.post('/secretariat/transaction-documentrequest/query',{id:idNow})
						.done(data =>{
						var dateRequested = moment(data.date_docurequested).format('MM/DD/YYYY');
						$('#documentAppend').append(`
						<div class="form-group m-0">
							<label class="label-control"><strong> Name of the Child: </strong> ${data.var_doclastname}, ${data.var_docfirstname}</label>
						</div>
						<div class="form-group">
							<label class="label-control"> <strong> Date: </strong> ${dateRequested}</label>
						</div>
						`)
						$('#viewModal').modal('show');	
						$('#cancelButton').css('display', 'block');
						$('#viewModal').on('hidden.bs.modal',function(){
									$('#documentAppend').empty()
						$('#UpdateButton').css('display', 'block');
								})
						$(document).on('click', '#generateButton', function(){
							$(document).off('click', '#generateButton')
							function toDataURL(url, callback) {
								var xhr = new XMLHttpRequest();
								xhr.onload = function() {
									var reader = new FileReader();
									reader.onloadend = function() {
									callback(reader.result);
									}
									reader.readAsDataURL(xhr.response);
								};
								xhr.open('GET', url);
								xhr.responseType = 'blob';
								xhr.send();
							}
							toDataURL(data.var_doctemplatepath, function(dataUrl) {
							var fullName = data.var_doclastname + ', ' + data.var_docfirstname;
							var dateRequested = moment(data.date_docurequested).format('MM/DD/YYYY');
								var docDefinition = { 
									content: [
										{
											image: dataUrl,
											width: 500,
											height: 100,
											
										},
									'Name: ' + fullName,
									'Date: ' + dateRequested
									]
								}
								pdfMake.createPdf(docDefinition).open();
								//- pdfMake.createPdf(docDefinition).on('hidden.bs.modal', function(){
								//- 	$(docDefinition).empty()
								//- })
							})
						})
					})
				})
			})
		
