extends ../../../../../templates/secretariat
block prepend main
    #wrap
    //- #calendar
    div(style='clear:both')
    .content
        .container-fluid
            .row
                .col-lg-12.col-md-12
                    // Tab panes
                    .tab-content
                        #nonwedding.tab-pane.active.mx-3
                            br
                            // Inner Nav tabs
                            ul.nav.nav-tabs
                                li.nav-item
                                    a.nav-link.active(data-toggle='tab', href='#anointing') Anointing of the Sick
                                li.nav-item
                                    a.nav-link(data-toggle='tab', href='#funeral') Funeral Blessing
                                li.nav-item
                                    a.nav-link(data-toggle='tab', href='#establishment') Establishment Blessing
                            // Tab panes
                            .tab-content
                                #anointing.tab-pane.active
                                    .card
                                            .card-header.card-header-primary(style='background:#367587; color:white')
                                                    h4.card-title(style='background:#367587; color:white') Anointing of the Sick
                                                    
                                            .card-body.table-responsive
                                                    table.table.table-hover.dataTable
                                                            thead.text-primary
                                                                    //- th ID
                                                                    th Sick
                                                                    th Event Date
                                                                    th Approval Status
                                                                    th.text-center(style=" width:11rem") Actions
                                                            tbody
                                                                each anointing in anointings
                                                                    tr
                                                                        //- td=anointing.int_eventinfoID
                                                                        td=anointing.var_lname + ", " + anointing.var_fname + " " + anointing.var_mname
                                                                        td=anointing.date_eventdate
                                                                        td=anointing.char_approvalstatus
                                                                        td.td-actions.text-center
                                                                                button.btn.btn-primary.actionButton(type='button' value=`${anointing.int_eventinfoID}`)
                                                                                        i.ti-settings
                                                                                                #toolbar-options.hidden
                                                                                                        a.viewButton(href='#')
                                                                                                                i.ti-new-window(style="color:white;")
                                                                                                        a.updateButton(href='#')
                                                                                                                i.ti-pencil(style="color:white;")
                                                                 
                                #funeral.tab-pane.fade
                                    .card
                                            .card-header.card-header-primary(style='background:#367587; color:white')
                                                    h4.card-title(style='background:#367587; color:white') Funeral Blessing
                                            .card-body.table-responsive
                                                    table.table.table-hover.dataTable
                                                            thead.text-primary
                                                                    //- th ID
                                                                    th Deceased
                                                                    th Event Date
                                                                    th Approval Status
                                                                    th.text-center(style=" width:120px") Actions
                                                            tbody
                                                                each funeral in funerals
                                                                    tr
                                                                        //- td=funeral.int_eventinfoID
                                                                        td=funeral.var_lname + ", " + funeral.var_fname + " " + funeral.var_mname
                                                                        td=funeral.date_eventdate
                                                                        td=funeral.char_approvalstatus
                                                                        td.td-actions.text-center
                                                                                button.btn.btn-primary.actionButton(type='button' value=`${funeral.int_eventinfoID}`)
                                                                                        i.ti-settings
                                                                                                #toolbar-options.hidden
                                                                                                        a.viewButton(href='#')
                                                                                                                i.ti-new-window(style="color:white;")
                                                                                                        a.updateButton(href='#')
                                                                                                                i.ti-pencil(style="color:white;")                //- tr
                                                                
                                #establishment.tab-pane.fade
                                    .card
                                        .card-header.card-header-primary(style='background:#367587; color:white')
                                                h4.card-title(style='background:#367587; color:white') Establishment Blessing
                                                
                                        .card-body.table-responsive
                                                table.table.table-hover.dataTable
                                                    thead.text-primary
                                                                //- th ID
                                                                th Owner
                                                                th Location
                                                                th Event schedule
                                                                th Approval Status
                                                                th.text-center(style=" width:120px") Actions
                                                    tbody
                                                            each establishment in establishments
                                                                tr
                                                                    //- td=establishment.int_eventinfoID
                                                                    td=establishment.var_owner
                                                                    td=establishment.var_estloc
                                                                    td=establishment.date_blessingdate + " "+ establishment.time_blessingstart
                                                                    td=establishment.char_approvalstatus
                                                                    td.td-actions.text-center
                                                                            button.btn.btn-primary.actionButton(type='button' value=`${establishment.int_eventinfoID}`)
                                                                                    i.ti-settings
                                                                                            #toolbar-options.hidden
                                                                                                    a.viewButton(href='#')
                                                                                                            i.ti-new-window(style="color:white;")
                                                                                                    a.updateButton(href='#')
                                                                                                            i.ti-pencil(style="color:white;")
    #updateModal.modal.fade(tabindex="-2" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true")
        .modal-dialog.modal-lg(role="document")
            .modal-content
                .modal-header(style='background:#367587; color:white')
                    h5.modal-title(style='background:#367587; color:white') Update Event Application
                    button.close(type='button', data-dismiss='modal', aria-label='Close')
                        span(aria-hidden='true')(style='background:#367587; color:white') ×
                .modal-body#updateBodyAppend
                .modal-footer
                    button.btn.btn-outline.btn-secondary.pull-left#cancelButton(type='button', data-dismiss='modal') Close
                    button.btn.btn-primary#updateSubmitButton(type="button") Update
    #viewModal.modal.fade(tabindex="-2" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true")
            .modal-dialog.modal-lg(role="document")
                .modal-content
                    .modal-header(style='background:#367587; color:white')
                        h5.modal-title(style='background:#367587; color:white') Blessing
                        button.close(type='button', data-dismiss='modal', aria-label='Close')
                            span(aria-hidden='true')(style='background:#367587; color:white') ×
                    .modal-body#viewBodyAppend
                    .modal-footer
                        button.btn.btn-outline.btn-secondary.pull-left#cancelButton(type='button', data-dismiss='modal') Close
    #myModal.modal(tabindex='-1', role='dialog', aria-labelledby='exampleModalLabel', aria-hidden='true')
        button.close(type='button', data-dismiss='modal', aria-label='Close')
            span(aria-hidden='true')(style='background:#367587; color:white') ×
        img.modal-content1#imgReq
block addjs
    script.
        $(document).ready(function() {
            var idNow;
            $('.actionButton').click(function(){
                idNow = $(this).val()
                console.log(idNow)
            })
            $('.viewButton').click(function(){
                console.log(idNow)
                $.post('/secretariat/transaction-blessings/query',{id:idNow}).done(data =>{
                    var desireddate = moment(data.date_eventdate).format('MM/DD/YYYY')
                    var timeRequested = moment(data.time_eventstart,'HH:mm:ss').format('hh:mm A')
                    $('#viewBodyAppend').append(`
                    <div class="form-group m-0">
                        <label class="label-control"><strong> Name of the relative: </strong> ${data.var_lname} , ${data.var_fname} ${data.var_mname}</label>
                    </div>
                    <div class="form-group">
                        <label class="label-control"><strong> Blessing Date: </strong>${desireddate} ${timeRequested}</label>
                    </div>
                    <div class="form-group">
                        <label class="label-control"><strong> Requirements: </strong> ${data.var_reqname}</label>
                    </div>
                    <div class="form-group">
                        <img id="myImg" class="img-responsive" alt ="${data.var_reqname}" src="${data.var_reqpath}" style="max-height:250px;">
                    </div>
                    `)
                
                $('#viewModal').modal('show')
                $('#viewModal').on('hidden.bs.modal',function(){
                    $('#viewBodyAppend').empty()
                })
                $('#myImg').click(function(){
                    $('#myModal').modal('show');
                    $("#imgReq").attr("src",`${data.var_reqpath}`);
                });
                })
            })
            $('.updateButton').click(function(){
                console.log(idNow)
                $.post('/secretariat/transaction-blessings/query/update',{id:idNow}).done(data =>{
                $('#updateBodyAppend').append(`
                    <col-md-4 class="p-lg-0">
                        <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                            <input id="eventid" type="hidden" value="${data.int_eventinfoID}"></input>
                            <input id="eventstatus" type="hidden" value="${data.char_approvalstatus}"></input>
                            <h6 class="label-control"><strong> Current Document Status : </strong> ${data.char_approvalstatus}</h6>
                        </div>
                        </div>
                        </div>
                        <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                            <input id="reqid" type="hidden" value="${data.int_requirementID}"></input>
                            <h6 class="label-control"><strong> Current Requirement Status : </strong> ${data.var_reqstatus}</h6>
                            <select id="reqstatus" type="text">
                            </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                            <input id="payid" type="hidden" value="${data.int_paymentID}"></input>
                            <h6 class="label-control"><strong> Current Payment Status: </strong> ${data.char_paymentstatus}</h6>
                            <select id="paystatus" type="text">
                            </select>
                            <div class="form-group">
                            <strong> Fee : </strong>P ${data.dbl_amount}.00
                            </div>
                            </div>
                        </div>
                        </div>
                        </div>
                    `)
                $('#updateModal').modal('show')
                $('#updateModal').on('hidden.bs.modal',function(){
                        $('#updateBodyAppend').empty()
                    })
                    if(data.char_paymentstatus == "Paid"){
                    $('#paystatus').append(`
                    <option selected="selected">Paid</option>
                    <option>Unpaid</option>
                    `)
                    }
                    else if(data.char_paymentstatus == "Unpaid"){
                    $('#paystatus').append(`
                    <option>Paid</option>
                    <option selected="selected">Unpaid</option>
                    `)
                    }
                    if(data.var_reqstatus == "Submitted"){
                    $('#reqstatus').append(`
                    <option selected="selected">Submitted</option>
                    <option>Approved</option>
                    `)
                    }
                    else if(data.var_reqstatus == "Approved"){
                    $('#reqstatus').append(`
                    <option>Submitted</option>
                    <option selected="selected">Approved</option>
                    `)
                    }
                    if(data.var_reqstatus == "Approved" && data.char_paymentstatus == "Paid"){
                        document.getElementById("paystatus").disabled=true;
                        document.getElementById("reqstatus").disabled=true;
                    }
                    $('#updateSubmitButton').click(function(){
                        swal({
                        title:'Are You Sure?', 
                        text:'You want to update the Status of the Request?', 
                        type:'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Confirm'
                        }).then((result)=>{
                        if(result.value){
                        data.time_eventstart = moment(data.time_eventstart,'HH:mm:ss').format('HH:mm:ss')
                        $.post('/secretariat/transaction-blessings/update',{
                        dateRequested:data.date_eventdate,
                        timeRequested:data.time_eventstart,
                        eventstatus:$('#eventstatus').val(),
                        eventid:$('#eventid').val(),
                        reqid:$('#reqid').val(),
                        reqstatus:$('#reqstatus').val(),
                        payid:$('#payid').val(),
                        paystatus:$('#paystatus').val()
                        })
                        .done(data=>{
                            if(data){
                                swal({
                                title:'Success',
                                text:'Status updated', 
                                type:'success'
                                }).then(function(){
                                    location.reload();
                                })
                                $('#updateModal').modal('hide');
                                $('#updateAppend').empty();
                            }
                        })
                        }
                    })
                    })
                })
            })
           
        });
